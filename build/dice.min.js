dice={roll:function(s,k){var e=dice.parse.parse(s);return dice.eval.eval(e,k)}};
dice.parse=function(){function s(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var k={parse:function(e,l){function b(a){var c={},b;for(b in a)c[b]=a[b];return c}function g(a,c){for(var b=a.offset+c,n=a.offset;n<b;n++){var d=e.charAt(n);"\n"===d?(a.seenCR||a.line++,a.column=1,a.seenCR=!1):"\r"===d||"\u2028"===d||"\u2029"===
d?(a.line++,a.column=1,a.seenCR=!0):(a.column++,a.seenCR=!1)}a.offset+=c}function d(a){c.offset<t.offset||(c.offset>t.offset&&(t=b(c),v=[]),v.push(a))}function y(){var a,f,e,d;d=b(c);a=w();null!==a?(f=z(),null!==f?(e=y(),null!==e?a=[a,f,e]:(a=null,c=b(d))):(a=null,c=b(d))):(a=null,c=b(d));null===a&&(a=w());return a}function w(){var a,f,e,d,g;d=b(c);g=b(c);a=u();null!==a?(f=q(),null!==f?(e=k(),null!==e?a=[a,f,e]:(a=null,c=b(g))):(a=null,c=b(g))):(a=null,c=b(g));null!==a&&(a={x:a[0],mode:a[1],min:a[2].min,
max:a[2].max});null===a&&(c=b(d));null===a&&(d=b(c),g=b(c),a=q(),null!==a?(f=k(),null!==f?a=[a,f]:(a=null,c=b(g))):(a=null,c=b(g)),null!==a&&(a={x:1,mode:a[0],min:a[1].min,max:a[1].max}),null===a&&(c=b(d)),null===a&&(d=b(c),a=u(),null!==a&&(a={x:1,mode:"d",min:a,max:a}),null===a&&(c=b(d)),null===a&&(d=b(c),a=k(),null!==a&&(a={x:1,mode:"d",min:a.min,max:a.max}),null===a&&(c=b(d)))));return a}function q(){var a;100===e.charCodeAt(c.offset)?(a="d",g(c,1)):(a=null,0===m&&d('"d"'));null===a&&(119===e.charCodeAt(c.offset)?
(a="w",g(c,1)):(a=null,0===m&&d('"w"')));return a}function k(){var a,f,h,n,p;n=b(c);p=b(c);a=u();null!==a?(".."===e.substr(c.offset,2)?(f="..",g(c,2)):(f=null,0===m&&d('".."')),null!==f?(h=u(),null!==h?a=[a,f,h]:(a=null,c=b(p))):(a=null,c=b(p))):(a=null,c=b(p));null!==a&&(a={min:a[0],max:a[2]});null===a&&(c=b(n));null===a&&(n=b(c),a=u(),null!==a&&(a={min:1,max:a}),null===a&&(c=b(n)));return a}function z(){var a,f,h,n,p;n=b(c);p=b(c);a=x();null!==a?(/^[+\-]/.test(e.charAt(c.offset))?(f=e.charAt(c.offset),
g(c,1)):(f=null,0===m&&d("[+\\-]")),null!==f?(h=x(),null!==h?a=[a,f,h]:(a=null,c=b(p))):(a=null,c=b(p))):(a=null,c=b(p));null!==a&&(a=a[1]);null===a&&(c=b(n));return a}function x(){var a,b;a=[];/^[ ]/.test(e.charAt(c.offset))?(b=e.charAt(c.offset),g(c,1)):(b=null,0===m&&d("[ ]"));for(;null!==b;)a.push(b),/^[ ]/.test(e.charAt(c.offset))?(b=e.charAt(c.offset),g(c,1)):(b=null,0===m&&d("[ ]"));return a}function u(){var a,d;d=b(c);a=A();null!==a&&(a=function(a,b,c,d){return function(){return d}}(d.offset,
d.line,d.column,a));null===a&&(c=b(d));null===a&&(d=b(c),a=B(),null!==a&&(a=function(a,b,c,d){return function(a){return a[d]}}(d.offset,d.line,d.column,a)),null===a&&(c=b(d)));return a}function B(){var a,f,h,n,p;n=b(c);p=b(c);91===e.charCodeAt(c.offset)?(a="[",g(c,1)):(a=null,0===m&&d('"["'));if(null!==a){/^[a-zA-Z 0-9]/.test(e.charAt(c.offset))?(h=e.charAt(c.offset),g(c,1)):(h=null,0===m&&d("[a-zA-Z 0-9]"));if(null!==h)for(f=[];null!==h;)f.push(h),/^[a-zA-Z 0-9]/.test(e.charAt(c.offset))?(h=e.charAt(c.offset),
g(c,1)):(h=null,0===m&&d("[a-zA-Z 0-9]"));else f=null;null!==f?(93===e.charCodeAt(c.offset)?(h="]",g(c,1)):(h=null,0===m&&d('"]"')),null!==h?a=[a,f,h]:(a=null,c=b(p))):(a=null,c=b(p))}else a=null,c=b(p);null!==a&&(a=a[1].join(""));null===a&&(c=b(n));return a}function A(){var a,f,h;m++;h=b(c);/^[0-9]/.test(e.charAt(c.offset))?(f=e.charAt(c.offset),g(c,1)):(f=null,0===m&&d("[0-9]"));if(null!==f)for(a=[];null!==f;)a.push(f),/^[0-9]/.test(e.charAt(c.offset))?(f=e.charAt(c.offset),g(c,1)):(f=null,0===
m&&d("[0-9]"));else a=null;null!==a&&(a=parseInt(a.join(""),10));null===a&&(c=b(h));m--;0===m&&null===a&&d("integer");return a}function D(a){a.sort();for(var b=null,c=[],d=0;d<a.length;d++)a[d]!==b&&(c.push(a[d]),b=a[d]);return c}var r={dicerolls:y,diceroll:w,rollmode:q,minmax:k,operation:z,ws:x,intval:u,variable:B,integer:A};if(void 0!==l){if(void 0===r[l])throw Error("Invalid rule name: "+s(l)+".");}else l="dicerolls";var c={offset:0,line:1,column:1,seenCR:!1},m=0,t={offset:0,line:1,column:1,seenCR:!1},
v=[],r=r[l]();if(null===r||c.offset!==e.length){var r=Math.max(c.offset,t.offset),E=r<e.length?e.charAt(r):null,C=c.offset>t.offset?c:t;throw new this.SyntaxError(D(v),E,r,C.line,C.column);}return r},toSource:function(){return this._source},SyntaxError:function(e,l,b,g,d){this.name="SyntaxError";this.expected=e;this.found=l;switch(e.length){case 0:e="end of input";break;case 1:e=e[0];break;default:e=e.slice(0,e.length-1).join(", ")+" or "+e[e.length-1]}l=l?s(l):"end of input";this.message="Expected "+
e+" but "+l+" found.";this.offset=b;this.line=g;this.column=d}};k.SyntaxError.prototype=Error.prototype;return k}();
dice.eval=function(){var s=function(b,e){return b+e},k=function(b){1==b.min&&(b.min=function(){return 1});1==b.x&&(b.x=function(){return 1});return b},e=function(b,e){if("+"==e||"-"==e)return b.mode=e,b;var d=l(e,b.scope),k=d.reduce(s);b.rolls=b.rolls.concat(d);"+"==b.mode?b.sum+=k:"-"==b.mode&&(b.sum-=k);return b},l=function(b,e){b=k(b);return _.range(0,b.x(e)).map(function(){var d;d=b.min(e);var k=b.max(e),l=b.mode;if(d==k)d=k;else{var q=_.random(d,k);if("d"==l)d=q;else{for(l=q;q==k;)q=_.random(d,
k),l+=q;d=l}}return d})};return{eval:function(b,g){g=g||{};var d=b;d instanceof Array||(d=[d]);b=_.flatten(d);d=b.reduce(e,{sum:0,mode:"+",rolls:[],scope:g});return{sum:d.sum,rolls:d.rolls}}}}();
