dice={roll:function(u,p){var d=dice.parse.parse(u);return dice.eval.eval(d,p)}};
dice.parse=function(){function u(d){return'"'+d.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var p={parse:function(d,n){function c(a){var b={},c;for(c in a)b[c]=a[c];return b}function k(a,b){for(var c=a.offset+b,l=a.offset;l<c;l++){var g=d.charAt(l);"\n"===g?(a.seenCR||a.line++,a.column=1,a.seenCR=!1):"\r"===g||"\u2028"===g||"\u2029"===
g?(a.line++,a.column=1,a.seenCR=!0):(a.column++,a.seenCR=!1)}a.offset+=b}function f(a){b.offset<v.offset||(b.offset>v.offset&&(v=c(b),x=[]),x.push(a))}function s(){var a,e,h,d;d=c(b);a=y();null!==a?(e=z(),null!==e?(h=s(),null!==h?a=[a,e,h]:(a=null,b=c(d))):(a=null,b=c(d))):(a=null,b=c(d));null===a&&(a=y());return a}function y(){var a,e,d,f,g;f=c(b);g=c(b);a=w();null!==a?(e=q(),null!==e?(d=p(),null!==d?a=[a,e,d]:(a=null,b=c(g))):(a=null,b=c(g))):(a=null,b=c(g));null!==a&&(a={x:a[0],mode:a[1],min:a[2].min,
max:a[2].max});null===a&&(b=c(f));null===a&&(f=c(b),g=c(b),a=q(),null!==a?(e=p(),null!==e?a=[a,e]:(a=null,b=c(g))):(a=null,b=c(g)),null!==a&&(a={x:1,mode:a[0],min:a[1].min,max:a[1].max}),null===a&&(b=c(f)),null===a&&(f=c(b),a=w(),null!==a&&(a={x:1,mode:"d",min:a,max:a}),null===a&&(b=c(f)),null===a&&(f=c(b),a=p(),null!==a&&(a={x:1,mode:"d",min:a.min,max:a.max}),null===a&&(b=c(f)))));return a}function q(){var a;100===d.charCodeAt(b.offset)?(a="d",k(b,1)):(a=null,0===m&&f('"d"'));null===a&&(119===d.charCodeAt(b.offset)?
(a="w",k(b,1)):(a=null,0===m&&f('"w"')));return a}function p(){var a,e,h,l,g;l=c(b);g=c(b);a=w();null!==a?(".."===d.substr(b.offset,2)?(e="..",k(b,2)):(e=null,0===m&&f('".."')),null!==e?(h=w(),null!==h?a=[a,e,h]:(a=null,b=c(g))):(a=null,b=c(g))):(a=null,b=c(g));null!==a&&(a={min:a[0],max:a[2]});null===a&&(b=c(l));null===a&&(l=c(b),a=w(),null!==a&&(a={min:1,max:a}),null===a&&(b=c(l)));return a}function z(){var a,e,h,l,g;l=c(b);g=c(b);a=t();null!==a?(/^[+\-]/.test(d.charAt(b.offset))?(e=d.charAt(b.offset),
k(b,1)):(e=null,0===m&&f("[+\\-]")),null!==e?(h=t(),null!==h?a=[a,e,h]:(a=null,b=c(g))):(a=null,b=c(g))):(a=null,b=c(g));null!==a&&(a=a[1]);null===a&&(b=c(l));null===a&&(l=c(b),g=c(b),a=t(),null!==a?(42===d.charCodeAt(b.offset)?(e="*",k(b,1)):(e=null,0===m&&f('"*"')),null!==e?(h=t(),null!==h?a=[a,e,h]:(a=null,b=c(g))):(a=null,b=c(g))):(a=null,b=c(g)),null!==a&&(a="*"),null===a&&(b=c(l)),null===a&&(l=c(b),g=c(b),a=t(),null!==a?(47===d.charCodeAt(b.offset)?(e="/",k(b,1)):(e=null,0===m&&f('"/"')),null!==
e?(h=t(),null!==h?a=[a,e,h]:(a=null,b=c(g))):(a=null,b=c(g))):(a=null,b=c(g)),null!==a&&(a="/"),null===a&&(b=c(l))));return a}function t(){var a,c;a=[];/^[ ]/.test(d.charAt(b.offset))?(c=d.charAt(b.offset),k(b,1)):(c=null,0===m&&f("[ ]"));for(;null!==c;)a.push(c),/^[ ]/.test(d.charAt(b.offset))?(c=d.charAt(b.offset),k(b,1)):(c=null,0===m&&f("[ ]"));return a}function w(){var a,e;e=c(b);a=A();null!==a&&(a=function(a,b,c,e){a=function(){return e};a.static=!0;return a}(e.offset,e.line,e.column,a));null===
a&&(b=c(e));null===a&&(e=c(b),a=B(),null!==a&&(a=function(a,b,c,e){a=function(a){return a[e]};a.static=!1;a.variable=e;return a}(e.offset,e.line,e.column,a)),null===a&&(b=c(e)));return a}function B(){var a,e,h,l,g;l=c(b);g=c(b);91===d.charCodeAt(b.offset)?(a="[",k(b,1)):(a=null,0===m&&f('"["'));if(null!==a){/^[a-zA-Z 0-9]/.test(d.charAt(b.offset))?(h=d.charAt(b.offset),k(b,1)):(h=null,0===m&&f("[a-zA-Z 0-9]"));if(null!==h)for(e=[];null!==h;)e.push(h),/^[a-zA-Z 0-9]/.test(d.charAt(b.offset))?(h=d.charAt(b.offset),
k(b,1)):(h=null,0===m&&f("[a-zA-Z 0-9]"));else e=null;null!==e?(93===d.charCodeAt(b.offset)?(h="]",k(b,1)):(h=null,0===m&&f('"]"')),null!==h?a=[a,e,h]:(a=null,b=c(g))):(a=null,b=c(g))}else a=null,b=c(g);null!==a&&(a=a[1].join(""));null===a&&(b=c(l));return a}function A(){var a,e,h,l,g;m++;l=c(b);/^[0-9]/.test(d.charAt(b.offset))?(e=d.charAt(b.offset),k(b,1)):(e=null,0===m&&f("[0-9]"));if(null!==e)for(a=[];null!==e;)a.push(e),/^[0-9]/.test(d.charAt(b.offset))?(e=d.charAt(b.offset),k(b,1)):(e=null,
0===m&&f("[0-9]"));else a=null;null!==a&&(a=parseInt(a.join(""),10));null===a&&(b=c(l));if(null===a){l=c(b);g=c(b);45===d.charCodeAt(b.offset)?(a="-",k(b,1)):(a=null,0===m&&f('"-"'));if(null!==a){/^[0-9]/.test(d.charAt(b.offset))?(h=d.charAt(b.offset),k(b,1)):(h=null,0===m&&f("[0-9]"));if(null!==h)for(e=[];null!==h;)e.push(h),/^[0-9]/.test(d.charAt(b.offset))?(h=d.charAt(b.offset),k(b,1)):(h=null,0===m&&f("[0-9]"));else e=null;null!==e?a=[a,e]:(a=null,b=c(g))}else a=null,b=c(g);null!==a&&(a=-1*parseInt(a[1].join(""),
10));null===a&&(b=c(l))}m--;0===m&&null===a&&f("integer");return a}function D(a){a.sort();for(var b=null,c=[],d=0;d<a.length;d++)a[d]!==b&&(c.push(a[d]),b=a[d]);return c}var r={dicerolls:s,diceroll:y,rollmode:q,minmax:p,operation:z,ws:t,intval:w,variable:B,integer:A};if(void 0!==n){if(void 0===r[n])throw Error("Invalid rule name: "+u(n)+".");}else n="dicerolls";var b={offset:0,line:1,column:1,seenCR:!1},m=0,v={offset:0,line:1,column:1,seenCR:!1},x=[],r=r[n]();if(null===r||b.offset!==d.length){var r=
Math.max(b.offset,v.offset),E=r<d.length?d.charAt(r):null,C=b.offset>v.offset?b:v;throw new this.SyntaxError(D(x),E,r,C.line,C.column);}return r},toSource:function(){return this._source},SyntaxError:function(d,n,c,k,f){this.name="SyntaxError";this.expected=d;this.found=n;switch(d.length){case 0:d="end of input";break;case 1:d=d[0];break;default:d=d.slice(0,d.length-1).join(", ")+" or "+d[d.length-1]}n=n?u(n):"end of input";this.message="Expected "+d+" but "+n+" found.";this.offset=c;this.line=k;this.column=
f}};p.SyntaxError.prototype=Error.prototype;return p}();
dice.eval=function(){var u=function(c,d){return c+d},p=function(c){1==c.min&&(c.min=function(){return 1});1==c.x&&(c.x=function(){return 1});return c},d=function(c,d){if(_.contains(["+","-","*","/"],d))return c.mode=d,c;var f=n(d,c.scope),s=f.reduce(u);c.rolls=c.rolls.concat(f);"+"==c.mode?c.sum+=s:"-"==c.mode?c.sum-=s:"*"==c.mode?c.sum*=s:"/"==c.mode&&(c.sum/=s);return c},n=function(c,d){c=p(c);return _.range(0,c.x(d)).map(function(){var f;f=c.min(d);var n=c.max(d),p=c.mode;if(f==n)f=n;else{var q=
_.random(f,n);if("d"==p)f=q;else{for(p=q;q==n;)q=_.random(f,n),p+=q;f=p}}return f})};return{eval:function(c,k){k=k||{};var f=c;f instanceof Array||(f=[f]);c=_.flatten(f);f=c.reduce(d,{sum:0,mode:"+",rolls:[],scope:k});return{sum:f.sum,rolls:f.rolls}}}}();
