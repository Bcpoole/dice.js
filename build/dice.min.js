dice={roll:function(u,p){var d=dice.parse.parse(u);return dice.eval.eval(d,p)}};
dice.parse=function(){function u(d){return'"'+d.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var p={parse:function(d,n){function c(a){var b={},c;for(c in a)b[c]=a[c];return b}function l(a,b){for(var c=a.offset+b,k=a.offset;k<c;k++){var h=d.charAt(k);"\n"===h?(a.seenCR||a.line++,a.column=1,a.seenCR=!1):"\r"===h||"\u2028"===h||"\u2029"===
h?(a.line++,a.column=1,a.seenCR=!0):(a.column++,a.seenCR=!1)}a.offset+=b}function g(a){b.offset<v.offset||(b.offset>v.offset&&(v=c(b),x=[]),x.push(a))}function s(){var a,f,e,d;d=c(b);a=y();null!==a?(f=A(),null!==f?(e=s(),null!==e?a=[a,f,e]:(a=null,b=c(d))):(a=null,b=c(d))):(a=null,b=c(d));null===a&&(a=y());return a}function y(){var a,f,e,d,h;d=c(b);h=c(b);a=w();null!==a?(f=q(),null!==f?(e=p(),null!==e?a=[a,f,e]:(a=null,b=c(h))):(a=null,b=c(h))):(a=null,b=c(h));null!==a&&(a={x:a[0],mode:a[1],min:a[2].min,
max:a[2].max});null===a&&(b=c(d));null===a&&(d=c(b),h=c(b),a=q(),null!==a?(f=p(),null!==f?a=[a,f]:(a=null,b=c(h))):(a=null,b=c(h)),null!==a&&(a={x:1,mode:a[0],min:a[1].min,max:a[1].max}),null===a&&(b=c(d)),null===a&&(d=c(b),a=w(),null!==a&&(a={x:1,mode:"d",min:a,max:a}),null===a&&(b=c(d)),null===a&&(d=c(b),a=p(),null!==a&&(a={x:1,mode:"d",min:a.min,max:a.max}),null===a&&(b=c(d)))));return a}function q(){var a;100===d.charCodeAt(b.offset)?(a="d",l(b,1)):(a=null,0===m&&g('"d"'));null===a&&(119===d.charCodeAt(b.offset)?
(a="w",l(b,1)):(a=null,0===m&&g('"w"')));return a}function p(){var a,f,e,k,h;k=c(b);h=c(b);a=w();null!==a?(".."===d.substr(b.offset,2)?(f="..",l(b,2)):(f=null,0===m&&g('".."')),null!==f?(e=w(),null!==e?a=[a,f,e]:(a=null,b=c(h))):(a=null,b=c(h))):(a=null,b=c(h));null!==a&&(a={min:a[0],max:a[2]});null===a&&(b=c(k));null===a&&(k=c(b),a=w(),null!==a&&(a={min:1,max:a}),null===a&&(b=c(k)));return a}function A(){var a,f,e,k,h;k=c(b);h=c(b);a=t();null!==a?(/^[+\-]/.test(d.charAt(b.offset))?(f=d.charAt(b.offset),
l(b,1)):(f=null,0===m&&g("[+\\-]")),null!==f?(e=t(),null!==e?a=[a,f,e]:(a=null,b=c(h))):(a=null,b=c(h))):(a=null,b=c(h));null!==a&&(a=a[1]);null===a&&(b=c(k));null===a&&(k=c(b),h=c(b),a=t(),null!==a?(42===d.charCodeAt(b.offset)?(f="*",l(b,1)):(f=null,0===m&&g('"*"')),null!==f?(e=t(),null!==e?a=[a,f,e]:(a=null,b=c(h))):(a=null,b=c(h))):(a=null,b=c(h)),null!==a&&(a="*"),null===a&&(b=c(k)),null===a&&(k=c(b),h=c(b),a=t(),null!==a?(47===d.charCodeAt(b.offset)?(f="/",l(b,1)):(f=null,0===m&&g('"/"')),null!==
f?(e=t(),null!==e?a=[a,f,e]:(a=null,b=c(h))):(a=null,b=c(h))):(a=null,b=c(h)),null!==a&&(a="/"),null===a&&(b=c(k))));return a}function t(){var a,c;a=[];/^[ ]/.test(d.charAt(b.offset))?(c=d.charAt(b.offset),l(b,1)):(c=null,0===m&&g("[ ]"));for(;null!==c;)a.push(c),/^[ ]/.test(d.charAt(b.offset))?(c=d.charAt(b.offset),l(b,1)):(c=null,0===m&&g("[ ]"));return a}function w(){var a,f,e,k;e=c(b);a=B();null!==a&&(a=function(a,b,c,d){a=function(){return d};a.static=!0;return a}(e.offset,e.line,e.column,a));
null===a&&(b=c(e));null===a&&(e=c(b),a=z(),null!==a&&(a=function(a,b,c,d){a=function(a){return a[d]};a.static=!1;a.variable=d;a.operation="none";return a}(e.offset,e.line,e.column,a)),null===a&&(b=c(e)),null===a&&(e=c(b),k=c(b),102===d.charCodeAt(b.offset)?(a="f",l(b,1)):(a=null,0===m&&g('"f"')),null!==a?(f=z(),null!==f?a=[a,f]:(a=null,b=c(k))):(a=null,b=c(k)),null!==a&&(a=function(a,b,c,d){a=function(a){return Math.floor(a[d])};a.static=!1;a.variable=d;a.operation="floor";return a}(e.offset,e.line,
e.column,a[1])),null===a&&(b=c(e))));return a}function z(){var a,f,e,k,h;k=c(b);h=c(b);91===d.charCodeAt(b.offset)?(a="[",l(b,1)):(a=null,0===m&&g('"["'));if(null!==a){/^[a-zA-Z 0-9]/.test(d.charAt(b.offset))?(e=d.charAt(b.offset),l(b,1)):(e=null,0===m&&g("[a-zA-Z 0-9]"));if(null!==e)for(f=[];null!==e;)f.push(e),/^[a-zA-Z 0-9]/.test(d.charAt(b.offset))?(e=d.charAt(b.offset),l(b,1)):(e=null,0===m&&g("[a-zA-Z 0-9]"));else f=null;null!==f?(93===d.charCodeAt(b.offset)?(e="]",l(b,1)):(e=null,0===m&&g('"]"')),
null!==e?a=[a,f,e]:(a=null,b=c(h))):(a=null,b=c(h))}else a=null,b=c(h);null!==a&&(a=a[1].join(""));null===a&&(b=c(k));return a}function B(){var a,f,e,k,h;m++;k=c(b);/^[0-9]/.test(d.charAt(b.offset))?(f=d.charAt(b.offset),l(b,1)):(f=null,0===m&&g("[0-9]"));if(null!==f)for(a=[];null!==f;)a.push(f),/^[0-9]/.test(d.charAt(b.offset))?(f=d.charAt(b.offset),l(b,1)):(f=null,0===m&&g("[0-9]"));else a=null;null!==a&&(a=parseInt(a.join(""),10));null===a&&(b=c(k));if(null===a){k=c(b);h=c(b);45===d.charCodeAt(b.offset)?
(a="-",l(b,1)):(a=null,0===m&&g('"-"'));if(null!==a){/^[0-9]/.test(d.charAt(b.offset))?(e=d.charAt(b.offset),l(b,1)):(e=null,0===m&&g("[0-9]"));if(null!==e)for(f=[];null!==e;)f.push(e),/^[0-9]/.test(d.charAt(b.offset))?(e=d.charAt(b.offset),l(b,1)):(e=null,0===m&&g("[0-9]"));else f=null;null!==f?a=[a,f]:(a=null,b=c(h))}else a=null,b=c(h);null!==a&&(a=-1*parseInt(a[1].join(""),10));null===a&&(b=c(k))}m--;0===m&&null===a&&g("integer");return a}function D(a){a.sort();for(var b=null,c=[],d=0;d<a.length;d++)a[d]!==
b&&(c.push(a[d]),b=a[d]);return c}var r={dicerolls:s,diceroll:y,rollmode:q,minmax:p,operation:A,ws:t,intval:w,variable:z,integer:B};if(void 0!==n){if(void 0===r[n])throw Error("Invalid rule name: "+u(n)+".");}else n="dicerolls";var b={offset:0,line:1,column:1,seenCR:!1},m=0,v={offset:0,line:1,column:1,seenCR:!1},x=[],r=r[n]();if(null===r||b.offset!==d.length){var r=Math.max(b.offset,v.offset),E=r<d.length?d.charAt(r):null,C=b.offset>v.offset?b:v;throw new this.SyntaxError(D(x),E,r,C.line,C.column);
}return r},toSource:function(){return this._source},SyntaxError:function(d,n,c,l,g){this.name="SyntaxError";this.expected=d;this.found=n;switch(d.length){case 0:d="end of input";break;case 1:d=d[0];break;default:d=d.slice(0,d.length-1).join(", ")+" or "+d[d.length-1]}n=n?u(n):"end of input";this.message="Expected "+d+" but "+n+" found.";this.offset=c;this.line=l;this.column=g}};p.SyntaxError.prototype=Error.prototype;return p}();
dice.eval=function(){var u=function(c,d){return c+d},p=function(c){1==c.min&&(c.min=function(){return 1});1==c.x&&(c.x=function(){return 1});return c},d=function(c,d){if(_.contains(["+","-","*","/"],d))return c.mode=d,c;var g=n(d,c.scope),s=g.reduce(u);c.rolls=c.rolls.concat(g);"+"==c.mode?c.sum+=s:"-"==c.mode?c.sum-=s:"*"==c.mode?c.sum*=s:"/"==c.mode&&(c.sum/=s);return c},n=function(c,d){c=p(c);return _.range(0,c.x(d)).map(function(){var g;g=c.min(d);var n=c.max(d),p=c.mode;if(g==n)g=n;else{var q=
_.random(g,n);if("d"==p)g=q;else{for(p=q;q==n;)q=_.random(g,n),p+=q;g=p}}return g})};return{eval:function(c,l){l=l||{};var g=c;g instanceof Array||(g=[g]);c=_.flatten(g);g=c.reduce(d,{sum:0,mode:"+",rolls:[],scope:l});return{sum:g.sum,rolls:g.rolls}}}}();
