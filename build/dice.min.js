dice={roll:function(s,k){var d=dice.parse.parse(s);return dice.eval.eval(d,k)}};
dice.parse=function(){function s(d){return'"'+d.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var k={parse:function(d,l){function b(a){var c={},b;for(b in a)c[b]=a[b];return c}function h(a,c){for(var b=a.offset+c,n=a.offset;n<b;n++){var e=d.charAt(n);"\n"===e?(a.seenCR||a.line++,a.column=1,a.seenCR=!1):"\r"===e||"\u2028"===e||"\u2029"===
e?(a.line++,a.column=1,a.seenCR=!0):(a.column++,a.seenCR=!1)}a.offset+=c}function e(a){c.offset<t.offset||(c.offset>t.offset&&(t=b(c),v=[]),v.push(a))}function y(){var a,f,g,d;d=b(c);a=w();null!==a?(f=z(),null!==f?(g=y(),null!==g?a=[a,f,g]:(a=null,c=b(d))):(a=null,c=b(d))):(a=null,c=b(d));null===a&&(a=w());return a}function w(){var a,f,d,e,h;e=b(c);h=b(c);a=u();null!==a?(f=q(),null!==f?(d=k(),null!==d?a=[a,f,d]:(a=null,c=b(h))):(a=null,c=b(h))):(a=null,c=b(h));null!==a&&(a={x:a[0],mode:a[1],min:a[2].min,
max:a[2].max});null===a&&(c=b(e));null===a&&(e=b(c),h=b(c),a=q(),null!==a?(f=k(),null!==f?a=[a,f]:(a=null,c=b(h))):(a=null,c=b(h)),null!==a&&(a={x:1,mode:a[0],min:a[1].min,max:a[1].max}),null===a&&(c=b(e)),null===a&&(e=b(c),a=u(),null!==a&&(a={x:1,mode:"d",min:a,max:a}),null===a&&(c=b(e)),null===a&&(e=b(c),a=k(),null!==a&&(a={x:1,mode:"d",min:a.min,max:a.max}),null===a&&(c=b(e)))));return a}function q(){var a;100===d.charCodeAt(c.offset)?(a="d",h(c,1)):(a=null,0===m&&e('"d"'));null===a&&(119===d.charCodeAt(c.offset)?
(a="w",h(c,1)):(a=null,0===m&&e('"w"')));return a}function k(){var a,f,g,n,p;n=b(c);p=b(c);a=u();null!==a?(".."===d.substr(c.offset,2)?(f="..",h(c,2)):(f=null,0===m&&e('".."')),null!==f?(g=u(),null!==g?a=[a,f,g]:(a=null,c=b(p))):(a=null,c=b(p))):(a=null,c=b(p));null!==a&&(a={min:a[0],max:a[2]});null===a&&(c=b(n));null===a&&(n=b(c),a=u(),null!==a&&(a={min:1,max:a}),null===a&&(c=b(n)));return a}function z(){var a,f,g,n,p;n=b(c);p=b(c);a=x();null!==a?(/^[+\-]/.test(d.charAt(c.offset))?(f=d.charAt(c.offset),
h(c,1)):(f=null,0===m&&e("[+\\-]")),null!==f?(g=x(),null!==g?a=[a,f,g]:(a=null,c=b(p))):(a=null,c=b(p))):(a=null,c=b(p));null!==a&&(a=a[1]);null===a&&(c=b(n));return a}function x(){var a,b;a=[];/^[ ]/.test(d.charAt(c.offset))?(b=d.charAt(c.offset),h(c,1)):(b=null,0===m&&e("[ ]"));for(;null!==b;)a.push(b),/^[ ]/.test(d.charAt(c.offset))?(b=d.charAt(c.offset),h(c,1)):(b=null,0===m&&e("[ ]"));return a}function u(){var a,d;d=b(c);a=A();null!==a&&(a=function(a,b,c,d){a=function(){return d};a.static=!0;
return a}(d.offset,d.line,d.column,a));null===a&&(c=b(d));null===a&&(d=b(c),a=B(),null!==a&&(a=function(a,b,c,d){a=function(a){return a[d]};a.static=!1;a.variable=d;return a}(d.offset,d.line,d.column,a)),null===a&&(c=b(d)));return a}function B(){var a,f,g,n,p;n=b(c);p=b(c);91===d.charCodeAt(c.offset)?(a="[",h(c,1)):(a=null,0===m&&e('"["'));if(null!==a){/^[a-zA-Z 0-9]/.test(d.charAt(c.offset))?(g=d.charAt(c.offset),h(c,1)):(g=null,0===m&&e("[a-zA-Z 0-9]"));if(null!==g)for(f=[];null!==g;)f.push(g),
/^[a-zA-Z 0-9]/.test(d.charAt(c.offset))?(g=d.charAt(c.offset),h(c,1)):(g=null,0===m&&e("[a-zA-Z 0-9]"));else f=null;null!==f?(93===d.charCodeAt(c.offset)?(g="]",h(c,1)):(g=null,0===m&&e('"]"')),null!==g?a=[a,f,g]:(a=null,c=b(p))):(a=null,c=b(p))}else a=null,c=b(p);null!==a&&(a=a[1].join(""));null===a&&(c=b(n));return a}function A(){var a,f,g;m++;g=b(c);/^[0-9]/.test(d.charAt(c.offset))?(f=d.charAt(c.offset),h(c,1)):(f=null,0===m&&e("[0-9]"));if(null!==f)for(a=[];null!==f;)a.push(f),/^[0-9]/.test(d.charAt(c.offset))?
(f=d.charAt(c.offset),h(c,1)):(f=null,0===m&&e("[0-9]"));else a=null;null!==a&&(a=parseInt(a.join(""),10));null===a&&(c=b(g));m--;0===m&&null===a&&e("integer");return a}function D(a){a.sort();for(var b=null,c=[],d=0;d<a.length;d++)a[d]!==b&&(c.push(a[d]),b=a[d]);return c}var r={dicerolls:y,diceroll:w,rollmode:q,minmax:k,operation:z,ws:x,intval:u,variable:B,integer:A};if(void 0!==l){if(void 0===r[l])throw Error("Invalid rule name: "+s(l)+".");}else l="dicerolls";var c={offset:0,line:1,column:1,seenCR:!1},
m=0,t={offset:0,line:1,column:1,seenCR:!1},v=[],r=r[l]();if(null===r||c.offset!==d.length){var r=Math.max(c.offset,t.offset),E=r<d.length?d.charAt(r):null,C=c.offset>t.offset?c:t;throw new this.SyntaxError(D(v),E,r,C.line,C.column);}return r},toSource:function(){return this._source},SyntaxError:function(d,l,b,h,e){this.name="SyntaxError";this.expected=d;this.found=l;switch(d.length){case 0:d="end of input";break;case 1:d=d[0];break;default:d=d.slice(0,d.length-1).join(", ")+" or "+d[d.length-1]}l=
l?s(l):"end of input";this.message="Expected "+d+" but "+l+" found.";this.offset=b;this.line=h;this.column=e}};k.SyntaxError.prototype=Error.prototype;return k}();
dice.eval=function(){var s=function(b,d){return b+d},k=function(b){1==b.min&&(b.min=function(){return 1});1==b.x&&(b.x=function(){return 1});return b},d=function(b,d){if("+"==d||"-"==d)return b.mode=d,b;var e=l(d,b.scope),k=e.reduce(s);b.rolls=b.rolls.concat(e);"+"==b.mode?b.sum+=k:"-"==b.mode&&(b.sum-=k);return b},l=function(b,d){b=k(b);return _.range(0,b.x(d)).map(function(){var e;e=b.min(d);var k=b.max(d),l=b.mode;if(e==k)e=k;else{var q=_.random(e,k);if("d"==l)e=q;else{for(l=q;q==k;)q=_.random(e,
k),l+=q;e=l}}return e})};return{eval:function(b,h){h=h||{};var e=b;e instanceof Array||(e=[e]);b=_.flatten(e);e=b.reduce(d,{sum:0,mode:"+",rolls:[],scope:h});return{sum:e.sum,rolls:e.rolls}}}}();
